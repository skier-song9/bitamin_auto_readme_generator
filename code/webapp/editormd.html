<!DOCTYPE html>
<html lang="ko">
    <head>
        <meta charset="utf-8" />
        <title>ProjectMe.md - Auto Readme Generator</title>
        <script src="{{url_for('static',filename='js/jquery.min.js')}}"></script>
        <link rel="stylesheet" href="{{url_for('static',filename='css/style.css')}}" />
        <link rel="stylesheet" href="{{url_for('static',filename='css/editormd.css')}}" />
        <link rel="shortcut icon" href="{{url_for('static',filename='images/orange.ico')}}" type="image/x-icon" />
        <style>      
            .editormd-preview-theme-dark {
                color: #777;
                background:#2C2827;
            }
            
            .editormd-preview-theme-dark .editormd-toc-menu > .markdown-toc {
                background:#fff;
                border:none;
            }
            
            .editormd-preview-theme-dark .editormd-toc-menu > .markdown-toc h1{
                border-color:#ddd;
            }
            
            .editormd-preview-theme-dark .markdown-body h1,
            .editormd-preview-theme-dark .markdown-body h2,
            .editormd-preview-theme-dark .markdown-body hr {
                border-color: #222;
            }
            
            .editormd-preview-theme-dark .editormd-preview-container  blockquote {
                color: #555;
                border-color: #333;
                background: #222;
                padding: 0.5em;
            }
            
            .editormd-preview-theme-dark .editormd-preview-container abbr {
                background:#ff9900;
                color: #fff;
                padding: 1px 3px;
                border-radius: 3px; 
            }
            
            .editormd-preview-theme-dark .editormd-preview-container code {
                background: #5A9600;
                color: #fff;
                border: none;
                padding: 1px 3px;
                border-radius: 3px; 
            }
            
            .editormd-preview-theme-dark .editormd-preview-container table {
                border: none;
            }
            
            .editormd-preview-theme-dark .editormd-preview-container .fa-emoji {
                color: #B4BF42;
            }
            
            .editormd-preview-theme-dark .editormd-preview-container .katex {
                color: #FEC93F;
            }
            
            .editormd-preview-theme-dark [class*=editormd-logo] {
                color: #2196F3;
            }
            
            .editormd-preview-theme-dark .sequence-diagram text {
                fill: #fff;
            }
            
            .editormd-preview-theme-dark .sequence-diagram rect, 
            .editormd-preview-theme-dark .sequence-diagram path {
                color:#fff;
                fill : #64D1CB;
                stroke : #64D1CB;
            }
            
            .editormd-preview-theme-dark .flowchart rect, 
            .editormd-preview-theme-dark .flowchart path {
                stroke : #A6C6FF;
            }
            
            .editormd-preview-theme-dark .flowchart rect {
                fill: #A6C6FF;
            }
            
            .editormd-preview-theme-dark .flowchart text {
                fill: #5879B4;
            }

            #test-editormd {
                border-radius: 10px;
                overflow: hidden;
            }

            .menu-bar-container {
                display: flex;
                justify-content: center;
                width: 100%;
                overflow-x: hidden; /* Í∞ÄÎ°ú Ïä§ÌÅ¨Î°§ ÌôúÏÑ±Ìôî */
                margin-bottom: 10px;
            }

            .menu-bar {
                background-color: rgb(248, 248, 248);
                width: 90%;
                padding: 10px;
                margin-bottom: 10px;
                border-radius: 5px;
                display: inline-block;
                overflow-x: auto; /* menu-bar ÎÇ¥ÏóêÏÑú Í∞ÄÎ°ú Ïä§ÌÅ¨Î°§ ÌôúÏÑ±Ìôî */
                white-space: nowrap; /* Ïù¥ÎØ∏ÏßÄ Í∞ÄÎ°úÎ°ú ÎÇòÏó¥ */
            }

            .image-gallery {
                display: inline-block;
            }

            .image-gallery img {
                width: 250px;
                height: 150px;
                margin-right: 5px; /* Ïù¥ÎØ∏ÏßÄ Í∞Ñ Í∞ÑÍ≤© */
                object-fit: contain; /* ÏõêÎ≥∏ ÎπÑÏú® Ïú†ÏßÄÌïòÎ©∞ Îπà Í≥µÍ∞Ñ Ìù∞ÏÉâ Ï±ÑÏö∞Í∏∞ */
                background-color: white; /* Îπà Í≥µÍ∞Ñ Ìù∞ÏÉâ Î∞∞Í≤Ω */
            }
            .image-gallery img:hover {
                cursor: pointer;
            }
            
            .menu-bar button {
                margin-right: 5px;
            }

            #layout {
                background-color: rgba(255,255,255,1);
                display: flex;
                flex-direction: column;
                align-items: center; /* Center horizontally */
            }
        
            /* File Upload Ïä§ÌÉÄÏùº */
            #upload-container {
                width: 90%;
                margin-bottom: 10px;
                text-align: center;
                padding: 20px;
                border: 2px dashed #ccc;
                border-radius: 10px;
                background-color: #f8f8f8;
                color: #666;
                cursor: pointer;
            }

            #upload-container.dragover {
                background-color: #e0e0e0;
                border-color: #333;
            }
        </style>     
    </head>
    <body>
        <div id="layout">
            <header style="display:flex; justify-content: space-between;">
                <h1 style="color: black; display: block;">
                    üçäBITAMin Auto-Project-ReadMe-Generator
                </h1>
                <button id="btn-download" style="display:none; font-size: 1.5em; cursor: pointer; background: none; border: none;" title="Download">
                    üíæDownload
                </button>
            </header>
            <input type="file" name="pdf" id="file-input" style="display:none;">
            <div id="upload-container">
                <!-- <input type="file" > -->
                <p id="upload-container-text">Drag & Drop or click here to upload your project PDF</p>
                
            </div>
            <div class="menu-bar-container">
                <!-- File Uploader -->
                
                <div class="menu-bar">
                    <div class="image-gallery">
                        <!-- <img id="image_netflix-stock_04_4" src="workspace/images/image_netflix-stock_04_4.jpg" alt="img1">
                        <img src="workspace/images/image_netflix-stock_05_4.jpg" alt="img2">
                        <img src="workspace/images/image_netflix-stock_07_4.jpg" alt="img3">
                        <img src="workspace/images/image_netflix-stock_08_4.jpg" alt="img4">
                        <img src="workspace/images/image_netflix-stock_09_3.jpg" alt="img5">
                        <img src="workspace/images/image_netflix-stock_09_4.jpg" alt="img6">
                        <img src="workspace/images/image_netflix-stock_09_5.jpg" alt="img7">
                        <img src="workspace/images/image_netflix-stock_11_4.jpg" alt="img8">
                        <img src="workspace/images/image_netflix-stock_12_4.jpg" alt="img9">
                        <img src="workspace/images/image_netflix-stock_14_5.jpg" alt="img10">
                        <img src="workspace/images/image_netflix-stock_15_3.jpg" alt="img11"> -->
                    </div>
                    <!-- <div class="btns">
                        <button id="light-dark">dark mode</button>
                        <button id="goto-line-btn">Goto line 90</button>
                        <button id="show-btn">Show editor</button>
                        <button id="hide-btn">Hide editor</button>
                        <button id="get-md-btn">Get Markdown</button>
                        <button id="get-html-btn">Get HTML</button>
                        <button id="watch-btn">Watch</button>
                        <button id="unwatch-btn">Unwatch</button>
                        <button id="preview-btn">Preview HTML (Press Shift + ESC cancel)</button>
                        <button id="fullscreen-btn">Fullscreen (Press ESC cancel)</button>
                        <button id="show-toolbar-btn">Show toolbar</button>
                        <button id="close-toolbar-btn">Hide toolbar</button>
                        <button id="toc-menu-btn">ToC Dropdown menu</button>
                        <button id="toc-default-btn">ToC default</button>
                    </div> -->
                </div>
            </div>
            <div class="menu-bar-container">
                <p>
                    Select Themes : 
                    <select id="editormd-theme-select">
                        <option selected="selected" value="">select Editor.md themes</option>
                    </select>
                    <select id="editor-area-theme-select">
                        <option selected="selected" value="">select editor area themes</option>
                    </select>
                    <select id="preview-area-theme-select">
                        <option selected="selected" value="">select preview area themes</option>
                    </select>
                </p>
            </div>
            <div id="your-readme">
                <textarea style="display:block;"></textarea>
            </div>
        </div>
        <script src="{{url_for('static',filename='editormd.js')}}"></script>
        <!-- English -->
        <script src="{{url_for('static',filename='languages/en.js')}}"></script>
        <script type="text/javascript">
            var yourReadme;
            var rootUrl = window.location.origin; // "http://ipaddr:port#" --> /code/ ÎîîÎ†âÌÜ†Î¶¨ÏûÑ.
            var imageGallery = $('.image-gallery')
            var workFileOrigin = "";
            var workFileClean = "";

            $(function() { //factory function 
                const session_json = {'workfileclean':[], 'workimagedir':[], 'pdf_filepath':[], 'pdf2img_dir':[], 'textbox_dir':[], 'text_filepath':[], 'md_filepath':[]}
                /////////////////////////////////////////////////////
                // File Uploader
                const uploadContainer = $('#upload-container');
                const fileInput = $('#file-input');
                function updateSessionJson(session_json, response_session) {
                    for (let key in session_json){
                        if(response_session[key].length > 0){
                            session_json[key] = session_json[key].concat(response_session[key])
                        }
                    }
                }
                // UploadFile Ìï®Ïàò
                // Upload file function
                function uploadFile(file) {
                    const formData = new FormData();
                    formData.append('file', file);

                    const uct = document.querySelector('#upload-container-text')
                    const gifPath = `${rootUrl}/webapp/images/loading.gif`;
                    const gifTag = document.createElement('img');
                    const btn_download = document.querySelector('#btn-download');
                    gifTag.src = gifPath;
                    gifTag.alt = "Loading & Processing...";
                    uct.textContent = '';
                    uct.appendChild(gifTag);

                    $.ajax({
                        url: `${rootUrl}/upload.do`, // Change this to your server-side upload handler
                        type: 'POST',
                        data: formData,
                        processData: false,
                        contentType: false,
                        success: function(response) {
                            // console.log(response)
                            switch (response.code) {
                                case 200:
                                    response_session = response.msg
                                    workFileOrigin = response.workfileorigin
                                    updateSessionJson(session_json, response_session)
                                    workFileClean = session_json['workfileclean'].at(-1)
                                    
                                    console.log(session_json)
                                    uct.removeChild(gifTag)
                                    uct.innerText = `${workFileOrigin}`

                                    loadImageGallery(session_json);
                                    attachImageOverlay('.image-gallery img');
                                    attachImageDragstart('.image-gallery img');

                                    $.ajax({
                                        url: "/loadfile.do",
                                        type : 'POST',
                                        contentType : 'application/json',
                                        data : JSON.stringify(session_json),
                                        dataType : 'json',
                                        success: function(response) {
                                            // "your-readme" idÎ•º Í∞ÄÏßÑ div ÌÉúÍ∑∏ ÎÇ¥Ïùò textarea ÏöîÏÜåÎ•º Ï∞æÎäîÎã§.
                                            let yourReadmeTextarea = document.querySelector('#your-readme textarea');
                                            if (response.code == 200){
                                                console.log(response.msg);
                                                // ÏùΩÏùÄ ÌÖçÏä§Ìä∏Î•º textarea ÏöîÏÜåÏùò valueÎ°ú ÏûÖÎ†•ÌïúÎã§.
                                                yourReadmeTextarea.value = response.msg;
                                                yourReadme = editormd("your-readme",{
                                                    width       : "90%",
                                                    height      : () => window.innerHeight * 0.75,
                                                    path        : 'lib/',
                                                    theme       : (localStorage.theme) ? localStorage.theme : "default",
                                                    previewTheme: (localStorage.previewTheme) ? localStorage.previewTheme : "default",
                                                    editorTheme : (localStorage.editorTheme) ? localStorage.editorTheme : "default",
                                                    codeFold    : true,
                                                    saveHTMLToTextarea : true,
                                                    searchReplace : true,
                                                    htmlDecode  : "style,script,iframe|on*",       
                                                    toc         : true,
                                                    emoji       : true,
                                                    taskList    : true,
                                                    tocm        : false,
                                                    tex         : true,                   
                                                    flowChart   : true,             
                                                    sequenceDiagram : true,
                                                    imageUpload : true,
                                                    imageFormats : ["jpg", "jpeg", "gif", "png", "bmp", "webp"],
                                                    // imageUploadURL : "./php/upload.php",
                                                    onload : function() {
                                                        console.log('onload', this);
                                                        // this.fullscreen();
                                                        //this.unwatch();
                                                        //this.watch().fullscreen();

                                                        //this.setMarkdown("#PHP");
                                                        // this.width("80%");
                                                        // this.height(480);
                                                        // this.resize("100%", 640);
                                                    }
                                                });
                                            }
                                            else{
                                                alert(response.msg);
                                            }
                                        },
                                        error: function(e) {
                                            alert(e);
                                        },
                                        xhrFields: {
                                            withCredentials: true  // Ïù¥ ÏÑ§Ï†ïÏúºÎ°ú Ïø†ÌÇ§Î•º ÏöîÏ≤≠Ïóê Ìè¨Ìï®ÏãúÌÇ¥
                                        }
                                    });

                                    // file loadingÏù¥ ÎÅùÎÇòÎ©¥ download Î≤ÑÌäºÏùÑ Î≥¥Ïù∏Îã§.
                                    btn_download.style.display = "block";

                                    break;
                                default: // code == 400
                                    uct.removeChild(gifTag)
                                    alert('File upload failed:' + response.msg);
                                    uct.innerText = "Drag & Drop or click here to upload your project PDF"
                                    break;
                            }
                        },
                        error: function(jqXHR, textStatus, errorThrown) {
                            uct.removeChild(gifTag)
                            uct.innerText = "Drag & Drop or click here to upload your project PDF"
                            console.error( textStatus, errorThrown);
                        },
                        xhrFields: {
                            withCredentials: true  // Ïù¥ ÏÑ§Ï†ïÏúºÎ°ú Ïø†ÌÇ§Î•º ÏöîÏ≤≠Ïóê Ìè¨Ìï®ÏãúÌÇ¥
                        }
                    });// upload.do

                    // loadImageGallery(); 
                    // attachImageOverlay('.image-gallery img');
                    // attachImageDragstart('.image-gallery img');
                }
                // upload containerÎ•º clickÌï¥ÎèÑ file-inputÏù¥ changeÍ∞Ä Î∞úÏÉùÌïòÎèÑÎ°ù Ìä∏Î¶¨Í±∞ Î∂ÄÏ∞©
                uploadContainer.on('click',function(e){
                    e.preventDefault();
                    if (!e.isTrigger){ // ÌÅ¥Î¶≠ Î¨¥ÌïúÎ£®ÌîÑ Î∞©ÏßÄ
                        fileInput.click();
                    }
                });
                // Handle file input change event
                fileInput.on('change',function(e){
                    const file = e.target.files[0];
                    if (file){
                        uploadFile(file); //ÏúÑÏùò uploadFile Ìï®Ïàò
                    }
                })
                // Handle dragover event
                uploadContainer.on('dragover', function(event) {
                    event.preventDefault();
                    uploadContainer.addClass('dragover');
                });
                // Handle drop event
                uploadContainer.on('drop', function(event) {
                    event.preventDefault();
                    uploadContainer.removeClass('dragover');
                    const file = event.originalEvent.dataTransfer.files[0];
                    if (file) {
                        uploadFile(file); //ÏúÑÏùò uploadFile Ìï®Ïàò
                    }
                });

                /////////////////////////////////////////////////////
                // Markdown Ìé∏ÏßëÍ∏∞Î•º Î∂àÎü¨Ïò®Îã§.
                $.ajax({
                    url: "/tutorial.do",
                    type : 'GET',
                    success: function(response) {
                        // "your-readme" idÎ•º Í∞ÄÏßÑ div ÌÉúÍ∑∏ ÎÇ¥Ïùò textarea ÏöîÏÜåÎ•º Ï∞æÎäîÎã§.
                        let yourReadmeTextarea = document.querySelector('#your-readme textarea');
                        if (response.code == 200){
                            console.log(response.msg);
                            // ÏùΩÏùÄ ÌÖçÏä§Ìä∏Î•º textarea ÏöîÏÜåÏùò valueÎ°ú ÏûÖÎ†•ÌïúÎã§.
                            yourReadmeTextarea.value = response.msg;
                            yourReadme = editormd("your-readme",{
                                width       : "90%",
                                height      : () => window.innerHeight * 0.75,
                                path        : 'lib/',
                                theme       : (localStorage.theme) ? localStorage.theme : "default",
                                previewTheme: (localStorage.previewTheme) ? localStorage.previewTheme : "default",
                                editorTheme : (localStorage.editorTheme) ? localStorage.editorTheme : "default",
                                codeFold    : true,
                                saveHTMLToTextarea : true,
                                searchReplace : true,
                                htmlDecode  : "style,script,iframe|on*",       
                                toc         : true,
                                emoji       : true,
                                taskList    : true,
                                tocm        : false,
                                tex         : true,                   
                                flowChart   : true,             
                                sequenceDiagram : true,
                                imageUpload : true,
                                imageFormats : ["jpg", "jpeg", "gif", "png", "bmp", "webp"],
                                // imageUploadURL : "./php/upload.php",
                                onload : function() {
                                    console.log('onload', this);
                                    // this.fullscreen();
                                    //this.unwatch();
                                    //this.watch().fullscreen();

                                    //this.setMarkdown("#PHP");
                                    // this.width("80%");
                                    // this.height(480);
                                    // this.resize("100%", 640);
                                }
                            });
                        }
                        else{
                            alert(response.msg);
                        }
                    },
                    error: function(e) {
                        alert(e);
                    },
                    xhrFields: {
                        withCredentials: true  // Ïù¥ ÏÑ§Ï†ïÏúºÎ°ú Ïø†ÌÇ§Î•º ÏöîÏ≤≠Ïóê Ìè¨Ìï®ÏãúÌÇ¥
                    }
                });

                /////////////////////////////////////////////////////
                // /webabb/workspace/images ÎÇ¥Ïùò Ïù¥ÎØ∏ÏßÄÎì§ÏùÑ Î∂àÎü¨ÏôÄ menu-barÏóê Í∞ÄÎ°úÎ°ú ÌëúÏãúÌïòÎäî Ìï®Ïàò.
                function loadImageGallery(session_json){
                    $.ajax({
                        url: '/loadimages.do',
                        type : 'POST',
                        contentType:'application/json',
                        data: JSON.stringify(session_json),
                        dataType:'json',
                        success: function(response) {
                            switch (response.code) {
                                case 200:
                                    // response_session = response.msg
                                    imgDir = response['dir']
                                    imgList = response['filelist']
                                    // console.log(data) // dataÎäî image file name list Ïù¥Îã§.
                                    if (imgList){
                                        imgList.forEach(function(imgName){
                                            if (imgName.match(/\.(jpg|jpeg|png|gif|bmp|webp)$/i)) {
                                                let altText = imgName.substring(0, imgName.lastIndexOf('.')); // Remove extension
                                                let srcText = `${rootUrl}/webapp/workspace/${imgDir}/${imgName}`;
                                                let imgTag = '<img id="'+ altText +'" src="' + srcText + '" alt="' + altText + '">';
                                                imageGallery.append(imgTag);
                                            }
                                        }); // forEach
                                    }// if
                                    break;
                            
                                default:
                                    alert("Fail to load Images...")
                                    break;
                            } // switch
                        }, //success
                        xhrFields: {
                            withCredentials: true  // Ïù¥ ÏÑ§Ï†ïÏúºÎ°ú Ïø†ÌÇ§Î•º ÏöîÏ≤≠Ïóê Ìè¨Ìï®ÏãúÌÇ¥
                        }
                    });
                }; // loadImageGallery()

                // Ïù¥ÎØ∏ÏßÄ ÌÅ¥Î¶≠ Ïãú ÌôîÎ©¥ Ï†ïÏ§ëÏïôÏóê Ïò§Î≤ÑÎ†àÏù¥ÌïòÎäî Ìï®Ïàò.
                function attachImageOverlay(cssSelector){
                    $(document).on('click',cssSelector,function(){
                        let imageSrc = $(this).attr('src');
                        let modal = `
                            <div id="image-modal" style="
                                position: fixed;
                                top: 0;
                                left: 0;
                                width: 100%;
                                height: 100%;
                                background-color: rgba(0, 0, 0, 0.8); /* 2. Î∞∞Í≤ΩÏùÄ Î∞òÌà¨Î™ÖÌïú Í≤ÄÏùÄÏÉâÏúºÎ°ú */
                                display: flex;
                                justify-content: center;
                                align-items: center;
                                z-index: 9999;
                            ">
                                <img src="${imageSrc}" style="
                                    max-width: 100%;
                                    max-height: 100%;
                                " />
                            </div>
                        `
                        $('body').append(modal);
                    });
                    // Îã§Ïãú ÌÅ¥Î¶≠ÌïòÎ©¥ Ïù¥ÎØ∏ÏßÄ Ïò§Î≤ÑÎ†àÏù¥ Ï†úÍ±∞
                    $(document).on('click','#image-modal',function(){
                        $('#image-modal').remove();
                    })
                }; // attachImageOverlay()

                /////////////////////////////////////////////////////
                // Image Drag & Drop Í∏∞Îä•
                // Drag start event: Save the dragged image's id
                function attachImageDragstart(cssSelector){
                    $(document).on('dragstart', cssSelector, function(e) {
                        e.originalEvent.dataTransfer.setData('text/plain',$(this).attr('id'));
                        // // dragÌïú Ïù¥ÎØ∏ÏßÄÏùò IdÎ•º draggedImageIdÏóê Ï†ÄÏû•ÌïúÎã§.
                        // draggedImageId = $(this).attr('id');
                        // // rootÏ£ºÏÜå + workspace/images + draggedImageId + .jpg Î¨∏ÏûêÏó¥ÏùÑ Í≤∞Ìï©ÌïòÏó¨Îùº.
                        // draggedImagePath = `${rootUrl}/webapp/workspace/images/${draggedImageId}.jpg`;
                    });
                }
                
                $(document).on('dragover', '.CodeMirror-code', function(e) {
                    // Drag ÌïòÎäî ÎèôÏïà markdown Ìé∏ÏßëÍ∏∞Ïùò Ïª§ÏÑúÎ•º Ïù¥ÎèôÏãúÌÇ®Îã§.
                    e.preventDefault();
                    let x = e.originalEvent.clientX;
                    let y = e.originalEvent.clientY;
                    
                    // drag Ï§ëÏóê cursorÏôÄ Í∞ÄÏû• Í∞ÄÍπåÏö¥ ÏúÑÏπòÏùò pre ÌÉúÍ∑∏Î•º ÏÑ†ÌÉù
                    const targetLine = document.elementFromPoint(x,y).closest('pre');
                    let currentLine = null;
                    if (targetLine){
                        currentLine = targetLine.previousElementSibling.innerText;
                    }

                    if (currentLine>0){
                        yourReadme.setCursor({'line':currentLine-1, 'ch':99999});
                        yourReadme.focus();
                    }

                });

                $(document).on('drop', '.CodeMirror-code', function(e) {
                    /*
                    markdown Ìé∏ÏßëÍ∏∞ ÎÇ¥ÏóêÏÑú drop Ïù¥Î≤§Ìä∏ Î∞úÏÉù Ïãú,
                    1. ÌòÑÏû¨ Ïª§ÏÑúÏôÄ Í∞ÄÏû• Í∞ÄÍπåÏö¥ pre ÌÉúÍ∑∏Î•º Ï∞æÎäîÎã§. -> ÌòÑÏû¨ Ïª§ÏÑúÏùò lineNumberÎ•º Ï∞æÎäîÎã§.
                    2. Ìï¥Îãπ Ïª§ÏÑúÎ°ú Ìé∏ÏßëÍ∏∞Ïùò Ïª§ÏÑúÎ•º Ïù¥ÎèôÏãúÌÇ§Í≥† focusÎ•º ÎßûÏ∂òÎã§.
                    3. Ìï¥Îãπ lineNumber Îã§Ïùå Ï§ÑÏóê imageÎ•º Ï∂îÍ∞ÄÌïúÎã§.
                    */
                    e.preventDefault();
                    const draggedElementId = e.originalEvent.dataTransfer.getData('text/plain');

                    let x = e.originalEvent.clientX;
                    let y = e.originalEvent.clientY;
                    // let imageId = e.originalEvent.dataTransfer.getData('text/plain');
                    // drag Ï§ëÏóê cursorÏôÄ Í∞ÄÏû• Í∞ÄÍπåÏö¥ ÏúÑÏπòÏùò pre ÌÉúÍ∑∏Î•º ÏÑ†ÌÉù
                    const targetLine = document.elementFromPoint(x,y).closest('pre');
                    let currentLine = null;
                    if (targetLine){
                        let prevLineNumber = targetLine.previousElementSibling.innerText;

                        yourReadme.setCursor({"line":parseInt(prevLineNumber-1),"ch":99999})
                        yourReadme.focus()
                        yourReadme.insertValue(`\n![${draggedElementId}](${rootUrl}/webapp/workspace/images_${workFileClean}/${draggedElementId}.jpg)`);
                        
                    }
                });
                
                /////////////////////////////////////////////////////
                // workspaceÏóêÏÑú md ÌååÏùºÏùÑ ÏùΩÏñ¥ your-readmeÏïÑÎûòÏùò textareaÏóê ÎÇ¥Ïö©ÏùÑ Ï±ÑÏö¥Îã§.
                function loadReadmeFile() {
                    $.ajax({
                        url: "/loadfile.do",
                        type : 'GET',
                        success: function(response) {
                            // "your-readme" idÎ•º Í∞ÄÏßÑ div ÌÉúÍ∑∏ ÎÇ¥Ïùò textarea ÏöîÏÜåÎ•º Ï∞æÎäîÎã§.
                            let yourReadmeTextarea = document.querySelector('#your-readme textarea');
                            if (response.code == 200){
                                // ÏùΩÏùÄ ÌÖçÏä§Ìä∏Î•º textarea ÏöîÏÜåÏùò valueÎ°ú ÏûÖÎ†•ÌïúÎã§.
                                yourReadmeTextarea.value = response.msg;
                            }
                            else{
                                alert(response.msg);
                            }
                            
                        },
                        error: function(e) {
                            alert(e);
                        },
                        xhrFields: {
                            withCredentials: true  // Ïù¥ ÏÑ§Ï†ïÏúºÎ°ú Ïø†ÌÇ§Î•º ÏöîÏ≤≠Ïóê Ìè¨Ìï®ÏãúÌÇ¥
                        }
                    });
                };

                /////////////////////////////////////////////////////
                // Markdown Ìé∏ÏßëÍ∏∞Ïùò ÌÖåÎßàÎ•º Î≥ÄÍ≤ΩÌïòÎäî select elementÎ•º ÏúÑÌïú Ìï®Ïàò.
                function themeSelectAll(id, editormd, lsKey, callback){
                    var select = $("#"+id);

                };
                function themeSelect(id, themes, lsKey, callback)
                {
                    var select = $("#" + id);
                    
                    for (var i = 0, len = themes.length; i < len; i ++)
                    {                    
                        var theme    = themes[i];
                        var selected = (localStorage[lsKey] == theme) ? " selected=\"selected\"" : "";
                        
                        select.append("<option value=\"" + theme + "\"" + selected + ">" + theme + "</option>");
                    }
                    
                    select.bind("change", function(){
                        var theme = $(this).val();
                        
                        if (theme === "")
                        {
                            alert("theme == \"\"");
                            return false;
                        }
                        
                        console.log("lsKey =>", lsKey, theme);
                        
                        localStorage[lsKey] = theme;
                        callback(select, theme);
                    }); 
                    
                    return select;
                };

                themeSelect("editormd-theme-select", editormd.themes, "theme", function($this, theme) {
                    yourReadme.setTheme(theme);
                });
                
                themeSelect("editor-area-theme-select", editormd.editorThemes, "editorTheme", function($this, theme) {
                    yourReadme.setCodeMirrorTheme(theme); 
                    // or yourReadme.setEditorTheme(theme);
                });
                
                themeSelect("preview-area-theme-select", editormd.previewThemes, "previewTheme", function($this, theme) {
                    yourReadme.setPreviewTheme(theme);
                });      

                window.addEventListener('beforeunload',function(e){
                    fetch('/endsession.do', {
                        method:'POST',
                        credentials:'same-origin',
                        headers:{
                            'Content-Type':'application/json',
                        },
                        body: JSON.stringify(session_json),
                        credentials: 'include'
                    }).then(response => {
                        if (response.ok){
                            console.log("Files removed successfully.")
                        }
                    }).catch(error => {
                        console.log(error)
                    })
                });

                // Drag over event: Necessary to allow a drop event
                // $('.CodeMirror-code').on('dragover', function(e) {
                //     e.preventDefault(); // Allow dropping
                //     // var textarea = this;
                //     let nearestDiv = getCursorPositionFromMouseEvent(e, textarea);
                //     console.log("nearestDiv: " + nearestDiv)



                //     // Ïª§ÏÑúÎ•º Í≥ÑÏÇ∞Îêú ÏúÑÏπòÎ°ú Ïù¥ÎèôÏãúÌÇµÎãàÎã§.
                //     // textarea.setSelectionRange(cursorPosition, cursorPosition);
                // });

                // Drop event: Insert the image ID at the cursor position
                // $('.CodeMirror-code').on('drop', function(e) {
                //     console.log('drop event')
                //     e.preventDefault();

                //     // Get the dropped text (image id)
                //     var imageId = e.originalEvent.dataTransfer.getData('text/plain');
                //     console.log('drop',imageId)

                //     // Find the cursor position and insert the image ID
                //     let cursorPos = this.selectionStart;
                //     let textAreaTxt = $(this).val();
                //     let textBefore = textAreaTxt.substring(0, cursorPos);
                //     let textAfter = textAreaTxt.substring(cursorPos, textAreaTxt.length);
                //     console.log(cursorPos + ", " + textAreaTxt)

                //     $(this).val(textBefore + imageId + textAfter);
                // });

                // function createNewImageLine(prevLineNumber,imageId) {
                //     // Make New Element
                //     let newdiv = document.createElement('div');
                //     newdiv.style.position='relative';
                //     let gutterWrapper = document.createElement('div');
                //     gutterWrapper.className = 'CodeMirror-gutter-wrapper';
                //     gutterWrapper.style.left = '-42px';
                //     gutterWrapper.style.width = '-42px';
                //     let lineNumber = document.createElement('div');
                //     lineNumber.className = 'CodeMirror-linenumber CodeMirror-gutter-elt';
                //     lineNumber.style.left = '-42px';
                //     lineNumber.style.width = '-42px';
                //     lineNumber.textContent = prevLineNumber+1;
                //     let pre = document.createElement('pre');
                //     let spanWrapper = document.createElement('span');
                //     spanWrapper.style.paddingRight = '0.1px';
                //     let spanTag = document.createElement('span');
                //     spanTag.className = 'cm-tag';
                //     spanTag.textContent = `![${imageId}]`;
                //     let spanString = document.createElement('span');
                //     spanString.className = 'cm-string';
                //     spanString.textContent = `(./webapp/workspace/images/${imageId}.jpg)`;

                //     // ÏöîÏÜåÎì§ÏùÑ Ïó∞Í≤∞
                //     spanWrapper.appendChild(spanTag)
                //     spanWrapper.appendChild(spanString)
                //     pre.appendChild(spanWrapper)
                //     gutterWrapper.appendChild(lineNumber)
                //     newdiv.appendChild(gutterWrapper)
                //     newdiv.appendChild(pre)             
                //     return newdiv       
                // }
                
                // $("#goto-line-btn").bind("click", function(){
                //     yourReadme.gotoLine(90);
                // });
                
                // $("#show-btn").bind('click', function(){
                //     yourReadme.show();
                // });
                
                // $("#hide-btn").bind('click', function(){
                //     yourReadme.hide();
                // });
                
                // $("#get-md-btn").bind('click', function(){
                //     alert(yourReadme.getMarkdown());
                // });
                
                // $("#get-html-btn").bind('click', function() {
                //     alert(yourReadme.getHTML());
                // });                
                
                // $("#watch-btn").bind('click', function() {
                //     yourReadme.watch();
                // });                 
                
                // $("#unwatch-btn").bind('click', function() {
                //     yourReadme.unwatch();
                // });              
                
                // $("#preview-btn").bind('click', function() {
                //     yourReadme.previewing();
                // });
                
                // $("#fullscreen-btn").bind('click', function() {
                //     yourReadme.fullscreen();
                // });
                
                // $("#show-toolbar-btn").bind('click', function() {
                //     yourReadme.showToolbar();
                // });
                
                // $("#close-toolbar-btn").bind('click', function() {
                //     yourReadme.hideToolbar();
                // });
                
                // $("#toc-menu-btn").click(function(){
                //     yourReadme.config({
                //         tocDropdown   : true,
                //         tocTitle      : "ÁõÆÂΩï Table of Contents",
                //     });
                // });
                
                // $("#toc-default-btn").click(function() {
                //     yourReadme.config("tocDropdown", false);
                // });


            }); // factory function
        </script>
    </body>
</html>